name: Claude Issue Triage
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  triage-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: >-
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && !github.event.issue.pull_request && github.event.comment.user.type != 'Bot')
    concurrency:
      group: issue-triage-${{ github.event.issue.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Claude Code for Issue Triage
        timeout-minutes: 5
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_non_write_users: "*"
          prompt: |
            You're an issue triage assistant. Analyze the issue and manage labels.

            IMPORTANT: Don't post any comments or messages to the issue. Your only actions are adding or removing labels.

            Context:
            - REPO: ${{ github.repository }}
            - ISSUE_NUMBER: ${{ github.event.issue.number }}
            - EVENT: ${{ github.event_name }}

            ALLOWED LABELS — you may ONLY use labels from this list. Never invent new labels.

            Type: bug, enhancement, question, documentation, duplicate, invalid
            Lifecycle: needs-repro, needs-info
            Platform: platform:linux, platform:macos, platform:windows, platform:wsl, platform:ios, platform:android, platform:vscode, platform:intellij, platform:web, platform:aws-bedrock
            API: api:bedrock, api:vertex

            TOOLS:
            - `gh issue view NUMBER`: Read the issue title, body, and labels
            - `gh issue view NUMBER --comments`: Read the conversation
            - `gh search issues QUERY`: Find similar or duplicate issues
            - `gh issue edit NUMBER --add-label` / `--remove-label`: Add or remove labels

            TASK:

            1. Run `gh issue view ${{ github.event.issue.number }}` to read the issue details.
            2. Run `gh issue view ${{ github.event.issue.number }} --comments` to read the conversation.

            **If EVENT is "issues" (new issue):**

            3. First, check if this issue is actually about Claude Code (the CLI/IDE tool). Issues about the Claude API, claude.ai, the Claude app, Anthropic billing, or other Anthropic products should be labeled `invalid`. If invalid, apply only that label and stop.

            4. Analyze and apply category labels:
               - Type (bug, enhancement, question, etc.)
               - Technical areas and platform
               - Check for duplicates with `gh search issues`. Only mark as duplicate of OPEN issues.

            5. Evaluate lifecycle labels:
               - `needs-repro` (bugs only, 7 days): Bug reports without clear steps to reproduce. A good repro has specific, followable steps that someone else could use to see the same issue.
                 Do NOT apply if the user already provided error messages, logs, file paths, or a description of what they did. Don't require a specific format — narrative descriptions count.
                 For model behavior issues (e.g. "Claude does X when it should do Y"), don't require traditional repro steps — examples and patterns are sufficient.
               - `needs-info` (bugs only, 7 days): The issue needs something from the community before it can progress — e.g. error messages, versions, environment details, or answers to follow-up questions. Don't apply to questions or enhancements.
                 Do NOT apply if the user already provided version, environment, and error details. If the issue just needs engineering investigation, that's not `needs-info`.

               Issues with these labels are automatically closed after the timeout if there's no response.
               The goal is to avoid issues lingering without a clear next step.

            6. Apply all selected labels:
               `gh issue edit ${{ github.event.issue.number }} --add-label "label1" --add-label "label2"`

            **If EVENT is "issue_comment" (comment on existing issue):**

            3. Evaluate lifecycle labels based on the full conversation:
               - If the issue has `needs-repro` or `needs-info` and the missing information has now been provided, remove the label:
                 `gh issue edit ${{ github.event.issue.number }} --remove-label "needs-repro"`
               - If the issue doesn't have lifecycle labels but clearly needs them (e.g., a maintainer asked for repro steps or more details), add the appropriate label.
               - Comments like "+1", "me too", "same here", or emoji reactions are NOT the missing information. Only remove labels when substantive details are actually provided.
               - Do NOT add or remove category labels (bug, enhancement, etc.) on comment events.

            GUIDELINES:
            - ONLY use labels from the ALLOWED LABELS list above — never create or guess label names
            - DO NOT post any comments to the issue
            - Be conservative with lifecycle labels — only apply when clearly warranted
            - Only apply lifecycle labels (`needs-repro`, `needs-info`) to bugs — never to questions or enhancements
            - When in doubt, don't apply a lifecycle label — false positives are worse than missing labels
            - It's okay to not add any labels if none are clearly applicable
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-opus-4-6
            --allowedTools "Bash(gh issue view:*),Bash(gh issue edit:*),Bash(gh search issues:*)"
